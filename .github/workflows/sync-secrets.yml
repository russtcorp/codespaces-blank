name: Sync Cloudflare Secrets

on:
  workflow_dispatch:

concurrency:
  group: sync-secrets-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  sync-worker-secrets:
    name: Sync Worker Secrets (Workers)
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
      MAGIC_LINK_SECRET: ${{ secrets.MAGIC_LINK_SECRET }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      TWILIO_PHONE_NUMBER: ${{ secrets.TWILIO_PHONE_NUMBER }}
      INSTAGRAM_CLIENT_ID: ${{ secrets.INSTAGRAM_CLIENT_ID }}
      INSTAGRAM_CLIENT_SECRET: ${{ secrets.INSTAGRAM_CLIENT_SECRET }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      MAILCHANNELS_API_TOKEN: ${{ secrets.MAILCHANNELS_API_TOKEN }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      EMAIL_FROM_DOMAIN: ${{ secrets.EMAIL_FROM_DOMAIN }}
      EMAIL_FROM_NAME: ${{ secrets.EMAIL_FROM_NAME }}
      SUPPORT_EMAIL: ${{ secrets.SUPPORT_EMAIL }}
      GOOGLE_OAUTH_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
      GOOGLE_OAUTH_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
      GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
      SITE_URL: ${{ secrets.SITE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Wrangler
        run: npm i -g wrangler@^3.90.0

      - name: Sync secrets to apps/agent
        working-directory: apps/agent
        shell: bash
        run: |
          set -euo pipefail
          put() { local k="$1" v="${!1:-}"; if [[ -n "$v" ]]; then printf "%s" "$v" | wrangler secret put "$k" --quiet; fi }
          put SESSION_SECRET
          put MAGIC_LINK_SECRET
          put STRIPE_SECRET_KEY
          put STRIPE_WEBHOOK_SECRET
          put TWILIO_ACCOUNT_SID
          put TWILIO_AUTH_TOKEN
          put TWILIO_PHONE_NUMBER
          put INSTAGRAM_CLIENT_ID
          put INSTAGRAM_CLIENT_SECRET
          put OPENAI_API_KEY
          put MAILCHANNELS_API_TOKEN
          put RESEND_API_KEY
          put EMAIL_FROM_DOMAIN
          put EMAIL_FROM_NAME
          put SUPPORT_EMAIL
          put GOOGLE_OAUTH_CLIENT_ID
          put GOOGLE_OAUTH_CLIENT_SECRET
          put GOOGLE_MAPS_API_KEY

      - name: Sync secrets to services/jobs
        working-directory: services/jobs
        shell: bash
        run: |
          set -euo pipefail
          put() { local k="$1" v="${!1:-}"; if [[ -n "$v" ]]; then printf "%s" "$v" | wrangler secret put "$k" --quiet; fi }
          put TWILIO_ACCOUNT_SID
          put TWILIO_AUTH_TOKEN
          put TWILIO_PHONE_NUMBER
          put STRIPE_SECRET_KEY
          put STRIPE_WEBHOOK_SECRET
          put OPENAI_API_KEY
          put MAILCHANNELS_API_TOKEN
          put RESEND_API_KEY
          put EMAIL_FROM_DOMAIN
          put EMAIL_FROM_NAME
          put SUPPORT_EMAIL

      - name: Sync secrets to services/workflows
        working-directory: services/workflows
        shell: bash
        run: |
          set -euo pipefail
          put() { local k="$1" v="${!1:-}"; if [[ -n "$v" ]]; then printf "%s" "$v" | wrangler secret put "$k" --quiet; fi }
          put INSTAGRAM_CLIENT_ID
          put INSTAGRAM_CLIENT_SECRET
          put OPENAI_API_KEY

  sync-pages-secrets:
    name: Sync Project Secrets (Pages)
    runs-on: ubuntu-latest
    needs: sync-worker-secrets
    strategy:
      fail-fast: false
      matrix:
        project:
          - name: diner-store
          - name: diner-admin
          - name: diner-public
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
      MAGIC_LINK_SECRET: ${{ secrets.MAGIC_LINK_SECRET }}
      TURNSTILE_SITE_KEY: ${{ secrets.TURNSTILE_SITE_KEY }}
      TURNSTILE_SECRET_KEY: ${{ secrets.TURNSTILE_SECRET_KEY }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      TWILIO_PHONE_NUMBER: ${{ secrets.TWILIO_PHONE_NUMBER }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      MAILCHANNELS_API_TOKEN: ${{ secrets.MAILCHANNELS_API_TOKEN }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      EMAIL_FROM_DOMAIN: ${{ secrets.EMAIL_FROM_DOMAIN }}
      EMAIL_FROM_NAME: ${{ secrets.EMAIL_FROM_NAME }}
      SUPPORT_EMAIL: ${{ secrets.SUPPORT_EMAIL }}
      SITE_URL: ${{ secrets.SITE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Wrangler
        run: npm i -g wrangler@^3.90.0

      - name: Sync secrets to ${{ matrix.project.name }}
        shell: bash
        run: |
          set -euo pipefail
          put() { local k="$1" v="${!1:-}"; if [[ -n "$v" ]]; then printf "%s" "$v" | wrangler pages secret put "$k" --project-name ${{ matrix.project.name }} --quiet; fi }
          put SESSION_SECRET
          put MAGIC_LINK_SECRET
          put TURNSTILE_SITE_KEY
          put TURNSTILE_SECRET_KEY
          put STRIPE_SECRET_KEY
          put STRIPE_WEBHOOK_SECRET
          put TWILIO_ACCOUNT_SID
          put TWILIO_AUTH_TOKEN
          put TWILIO_PHONE_NUMBER
          put OPENAI_API_KEY
          put MAILCHANNELS_API_TOKEN
          put RESEND_API_KEY
          put EMAIL_FROM_DOMAIN
          put EMAIL_FROM_NAME
          put SUPPORT_EMAIL
          put SITE_URL
